# Neogen 模板中的 $1 详解

## 🎯 $1 是什么？

**`$1` 是占位符（Placeholder）标记**，表示"这里需要用户填写内容，并且可以跳转到这里"。

### 简单理解

```lua
{ nil, "/ 这是描述：$1", { type = { "func" } } }
```

**生成结果**：
```rust
/// 这是描述：█  ← 光标会停在这里，等待你输入
```

---

## 🔢 数字的含义

### `$1`, `$2`, `$3` ... 表示跳转顺序

```lua
local template = {
    { nil, "/ 第一个位置：$1", { type = { "func" } } },
    { nil, "/ 第二个位置：$2", { type = { "func" } } },
    { nil, "/ 第三个位置：$3", { type = { "func" } } },
}
```

**生成后**：
```rust
/// 第一个位置：█          ← 光标在这（$1）
/// 第二个位置：[TODO]     ← 按 Tab 会跳到这（$2）
/// 第三个位置：[TODO]     ← 再按 Tab 跳到这（$3）
```

### ⚠️ 但在 Neogen 中，所有 `$1` 都是一样的！

**关键点**：Neogen 的实现中，**所有 `$1` 都按出现顺序依次跳转**，不支持 `$2`, `$3` 等。

```lua
-- Neogen 中这样写
{ nil, "/ 位置1：$1", { type = { "func" } } },
{ nil, "/ 位置2：$1", { type = { "func" } } },
{ nil, "/ 位置3：$1", { type = { "func" } } },

-- 等同于第 1、2、3 个跳转点
```

---

## 🎨 $1 在模板中的使用

### 示例 1：固定文本 + 占位符

```lua
{ nil, "/ 这是一个函数，用途是：$1", { type = { "func" } } }
```

**生成**：
```rust
/// 这是一个函数，用途是：█
```

**用户操作**：
1. 自动进入插入模式
2. 光标在 `█` 位置
3. 直接打字：`计算两数之和`
4. 结果：`/// 这是一个函数，用途是：计算两数之和`

### 示例 2：多个 $1 在一行

```lua
{ nil, "/ 参数 $1 的类型是 $1", { type = { "func" } } }
```

**生成**：
```rust
/// 参数 █ 的类型是 [TODO]    ← 第一个 $1
```

**操作**：
1. 输入：`value`
2. 按 `Tab`
3. 跳到：`/// 参数 value 的类型是 █`  ← 第二个 $1
4. 输入：`i32`
5. 结果：`/// 参数 value 的类型是 i32`

### 示例 3：与 %s 配合使用

```lua
{ i.Parameter, "/ - `%s`: $1", { type = { "func" } } }
```

**假设函数有参数 `name` 和 `age`**

**生成**：
```rust
/// - `name`: █              ← 第1个 $1（对应 name）
/// - `age`: [TODO]          ← 第2个 $1（对应 age）
```

**说明**：
- `%s` 被替换为参数名 `name`
- `$1` 是光标跳转位置
- 这样每个参数都有一个跳转点

---

## 🔍 $1 与 %s 的区别

### %s - 格式化占位符

**作用**：被实际提取的内容替换

```lua
{ i.Parameter, "/ 参数名是：%s", { type = { "func" } } }
```

**如果函数是**：
```rust
fn test(param1: i32, param2: String) { }
```

**生成**：
```rust
/// 参数名是：param1
/// 参数名是：param2
```

`%s` 被替换为实际的参数名！

### $1 - 光标跳转占位符

**作用**：标记用户需要填写的位置

```lua
{ i.Parameter, "/ 参数 %s 的用途：$1", { type = { "func" } } }
```

**生成**：
```rust
/// 参数 param1 的用途：█       ← $1 变成光标位置
/// 参数 param2 的用途：[TODO]  ← 下一个 $1
```

### 对比表格

| 符号 | 含义 | 被替换为 | 示例 |
|------|------|---------|------|
| `%s` | 格式化占位符 | 提取的数据（如参数名） | `%s` → `param1` |
| `$1` | 光标跳转点 | 用户输入的内容 | `$1` → `█` 光标 |

---

## 💡 实际完整示例

### 模板定义

```lua
local i = require("neogen.types.template").item

local my_template = {
    -- 第1行：固定文本 + 占位符
    { nil, "/ $1", { type = { "func" } } },
    { nil, "/ ", { type = { "func" } } },
    
    -- 第2部分：参数列表
    { nil, "/ # Params:", { type = { "func" } } },
    { i.Parameter, "/ - `%s`: $1", { type = { "func" } } },
    
    -- 第3部分：返回值
    { nil, "/ ", { type = { "func" } } },
    { nil, "/ # Return", { type = { "func" } } },
    { nil, "/ $1", { type = { "func" } } },
}
```

### 应用到函数

```rust
fn calculate(x: i32, y: i32) -> i32 {
    x + y
}
```

### 生成结果（第1步）

```rust
/// █                           ← 第1个 $1，光标在这
///
/// # Params:
/// - `x`: [TODO:parameter]     ← 第2个 $1
/// - `y`: [TODO:parameter]     ← 第3个 $1
///
/// # Return
/// [TODO:return]               ← 第4个 $1
fn calculate(x: i32, y: i32) -> i32 {
    x + y
}
```

### 填写过程

**Step 1**：光标在第1个 `$1`
```rust
/// █  ← 输入 "计算两数之和"
```

**Step 2**：按 `Tab`，跳到第2个 `$1`
```rust
/// 计算两数之和
///
/// # Params:
/// - `x`: █  ← 输入 "第一个数字"
/// - `y`: [TODO:parameter]
```

**Step 3**：按 `Tab`，跳到第3个 `$1`
```rust
/// 计算两数之和
///
/// # Params:
/// - `x`: 第一个数字
/// - `y`: █  ← 输入 "第二个数字"
```

**Step 4**：按 `Tab`，跳到第4个 `$1`
```rust
/// 计算两数之和
///
/// # Params:
/// - `x`: 第一个数字
/// - `y`: 第二个数字
///
/// # Return
/// █  ← 输入 "两数之和"
```

**最终结果**：
```rust
/// 计算两数之和
///
/// # Params:
/// - `x`: 第一个数字
/// - `y`: 第二个数字
///
/// # Return
/// 两数之和
fn calculate(x: i32, y: i32) -> i32 {
    x + y
}
```

---

## 🎯 $1 的工作原理

### 内部处理流程

```lua
-- 1. 模板定义
{ nil, "/ Description: $1", { type = { "func" } } }

-- 2. Neogen 处理
-- 找到所有 $1，记录位置
local marks = {}
table.insert(marks, { row = 1, col = 17 })  -- "Description: " 后面

-- 3. 生成时
-- 将 $1 替换为占位符文本（如 [TODO:description]）
"/// Description: [TODO:description]"

-- 4. Snippet Engine 接手
-- 将占位符位置传给 snippet engine
-- snippet engine 把光标移到这些位置
```

### 与 Snippet Engine 的配合

```lua
-- Neogen 生成的 LSP 格式片段
{
    "/// ${1:description}",
    "/// ",
    "/// # Params:",
    "/// - `param1`: ${2:description}",
}

-- Snippet Engine 解析
-- ${1:description} → 第1个跳转点，默认文本是 "description"
-- ${2:description} → 第2个跳转点
```

---

## 🔧 高级用法

### 用法 1：条件性 $1

```lua
-- 只在有参数时显示
{ nil, "/ # Params:", { type = { "func" } } },
{ i.Parameter, "/ - `%s`: $1", { type = { "func" } } },

-- 无参数时显示
{ nil, "/ 无参数函数：$1", { no_results = true, type = { "func" } } },
```

**有参数**：
```rust
/// ...
/// # Params:
/// - `x`: █       ← 有 $1
```

**无参数**：
```rust
/// 无参数函数：█  ← 也有 $1
```

### 用法 2：$1 在不同位置

```lua
{
    -- 标题部分
    { nil, "/ # $1", { type = { "func" } } },
    { nil, "/ ", { type = { "func" } } },
    { nil, "/ ## 详细说明", { type = { "func" } } },
    { nil, "/ $1", { type = { "func" } } },
    { nil, "/ ", { type = { "func" } } },
    
    -- 参数部分
    { nil, "/ ## 参数", { type = { "func" } } },
    { i.Parameter, "/ - `%s` ($1): $1", { type = { "func" } } },
    --                    ^^^^  ^^^^
    --                    类型   说明
}
```

**生成**：
```rust
/// # █                        ← 第1个 $1（标题）
///
/// ## 详细说明
/// █                          ← 第2个 $1（详细说明）
///
/// ## 参数
/// - `param1` (█): [TODO]     ← 第3个 $1（param1的类型）
/// - `param1` (i32): █        ← 第4个 $1（param1的说明）
```

### 用法 3：不使用 $1（纯文本）

```lua
-- 不带 $1 的行
{ nil, "/ ================================", { type = { "func" } } },
{ nil, "/ 函数说明", { type = { "func" } } },
{ nil, "/ ================================", { type = { "func" } } },
```

**生成**：
```rust
/// ================================
/// 函数说明
/// ================================
```

无跳转点，纯装饰性。

---

## ❓ 常见问题

### Q1: 我可以用 $2, $3 吗？

**A**: 在 Neogen 中**不推荐**。虽然 LSP snippet 支持，但 Neogen 的实现是按顺序处理所有 `$1`。

**推荐写法**：
```lua
{ nil, "/ 第1个：$1" },
{ nil, "/ 第2个：$1" },  -- 都用 $1
{ nil, "/ 第3个：$1" },
```

### Q2: $1 可以有默认值吗？

**A**: 可以通过 `placeholders_text` 配置：

```lua
require('neogen').setup({
    placeholders_text = {
        ["description"] = "请填写描述",
        ["parameter"] = "参数说明",
    }
})
```

**生成时**：
```rust
/// 请填写描述        ← $1 显示为 "请填写描述"
/// - `param`: 参数说明  ← $1 显示为 "参数说明"
```

### Q3: 没有 $1 会怎样？

**A**: 那一行就是纯文本，不可跳转。

```lua
{ nil, "/ 这是固定文字" },  -- 无 $1
```

**生成**：
```rust
/// 这是固定文字  ← 无跳转点
```

### Q4: 多个 $1 在同一行？

**A**: 可以，按从左到右的顺序跳转。

```lua
{ nil, "/ Type: $1, Default: $1" }
```

**跳转顺序**：
```rust
/// Type: █, Default: [TODO]  ← 先跳到第1个
/// Type: i32, Default: █      ← 再跳到第2个
```

---

## 📝 总结

### $1 的本质

| 特性 | 说明 |
|------|------|
| **是什么** | 光标跳转标记 |
| **被替换为** | 占位符文本（可配置） |
| **作用** | 标记用户需要填写的位置 |
| **跳转方式** | 按出现顺序，用 Tab 键跳转 |

### 与其他符号的关系

```lua
{ i.Parameter, "/ - `%s` (%s类型): $1" }
--                  ^^^  ^^       ^^^
--                  |    |        |
--                  |    |        └─ $1: 光标跳转点（用户填写）
--                  |    └────────── %s: 格式化（第2个提取的值）
--                  └──────────────── %s: 格式化（第1个提取的值）
```

### 快速记忆

- **`%s`** = 自动填写（来自代码提取）
- **`$1`** = 手动填写（光标跳转点）

### 实用建议

1. **每个需要用户填写的地方都加 `$1`**
2. **固定文本不需要 `$1`**
3. **所有 `$1` 在 Neogen 中都一样，按顺序跳转**
4. **配合 snippet engine 使用体验最佳**

希望这样解释清楚了！🎉
